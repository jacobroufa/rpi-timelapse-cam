---
phase: 02-web-ui-timeline-browser
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/timelapse/web/__init__.py
  - src/timelapse/web/health.py
  - src/timelapse/web/blueprints/__init__.py
  - src/timelapse/web/blueprints/timeline.py
  - src/timelapse/web/blueprints/latest.py
  - src/timelapse/web/blueprints/control.py
  - src/timelapse/web/templates/base.html
  - src/timelapse/web/templates/timeline.html
  - src/timelapse/web/templates/latest.html
  - src/timelapse/web/templates/control.html
  - src/timelapse/web/static/css/pico.min.css
  - src/timelapse/web/static/css/app.css
  - config/timelapse.yml
autonomous: true
requirements: [WEB-01, WEB-06, WEB-07]

must_haves:
  truths:
    - "User can open the web UI in a browser and see three tabs: Timeline, Latest Image, Control"
    - "Active tab is visually indicated in the tab bar"
    - "Subtle health indicators are visible on every tab showing disk usage and daemon status"
    - "Hovering a health indicator reveals full system info in a tooltip/popup"
    - "Disk space warning is visually prominent when free space is below threshold"
  artifacts:
    - path: "src/timelapse/web/__init__.py"
      provides: "Flask application factory"
      exports: ["create_app"]
      contains: "create_app"
    - path: "src/timelapse/web/health.py"
      provides: "Health data aggregation from .status.json"
      exports: ["get_health_summary"]
      contains: "read_status"
    - path: "src/timelapse/web/templates/base.html"
      provides: "Base layout with tab bar and health indicators"
      contains: "health-bar"
    - path: "src/timelapse/web/static/css/pico.min.css"
      provides: "Pico CSS framework for base styling"
    - path: "src/timelapse/web/static/css/app.css"
      provides: "Custom styles for filmstrip, health indicators, tab states"
  key_links:
    - from: "src/timelapse/web/__init__.py"
      to: "src/timelapse/config.py"
      via: "load_config to get output_dir and thresholds"
      pattern: "load_config"
    - from: "src/timelapse/web/__init__.py"
      to: "src/timelapse/web/health.py"
      via: "context_processor inject_health on every request"
      pattern: "inject_health"
    - from: "src/timelapse/web/health.py"
      to: "src/timelapse/status.py"
      via: "read_status to get daemon state from .status.json"
      pattern: "read_status"
    - from: "src/timelapse/web/templates/base.html"
      to: "src/timelapse/web/__init__.py"
      via: "Jinja2 context variable 'health' from context_processor"
      pattern: "health\\."
---

<objective>
Create the Flask application skeleton: app factory, base template with three-tab navigation and health indicators, health module, static assets (Pico CSS + custom CSS), stub blueprints, and web config section. This is the foundation every other web plan builds on.

Purpose: Establishes the Flask application structure that all subsequent plans (Timeline, Latest Image, Control) extend with their specific routes, templates, and JavaScript. The health indicators on every page provide the disk space warnings and daemon status display required by WEB-06 and WEB-07.

Output: Running Flask app with three tabs, health indicators, and placeholder content on each tab.
</objective>

<execution_context>
@/Users/jacobroufa/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacobroufa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-web-ui-timeline-browser/02-RESEARCH.md
@src/timelapse/config.py
@src/timelapse/status.py
@config/timelapse.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Flask app factory, health module, stub blueprints, and web config</name>
  <files>src/timelapse/web/__init__.py, src/timelapse/web/health.py, src/timelapse/web/blueprints/__init__.py, src/timelapse/web/blueprints/timeline.py, src/timelapse/web/blueprints/latest.py, src/timelapse/web/blueprints/control.py, config/timelapse.yml</files>
  <action>
NOTE: `src/timelapse/web/__init__.py` may already exist from Plan 01 (empty). Read it first -- if it exists and is empty, overwrite it with the app factory. If Plan 01 has not run yet, create the web/ package directory.

Create `src/timelapse/web/__init__.py` with `create_app(config_path: Path | None = None) -> Flask`:
- Import Flask, load_config from timelapse.config
- If config_path is None, use the same fallback chain as __main__.py: /etc/timelapse/timelapse.yml > ./config/timelapse.yml
- Call load_config() to get the timelapse config dict
- Store in app.config["TIMELAPSE"] (full config), app.config["OUTPUT_DIR"] (Path to output dir), app.config["STATUS_FILE"] (output_dir / ".status.json")
- Set app.config["SECRET_KEY"] = "timelapse-local-network" (only used for flash messages, local network only)
- Register three blueprints: timeline_bp (url_prefix="/"), latest_bp (url_prefix="/latest"), control_bp (url_prefix="/control")
- The timeline blueprint is at "/" so the Timeline tab is the default/home page
- Register a context_processor that injects `health` dict into all templates (calls get_health_summary)
- Add a default route redirect: if someone hits "/" they get the timeline index

Create `src/timelapse/web/health.py` with:
- `get_health_summary(status_path: Path, config: dict) -> dict`: reads .status.json via `read_status()` from `timelapse.status`, returns dict with keys: daemon_state, last_capture, disk_usage_percent, disk_free_gb, disk_warning (bool: True if disk_usage_percent >= warn_threshold), captures_today, consecutive_failures, camera, uptime_seconds, config_loaded, capture_interval (from config for display)
- `get_full_system_info() -> dict`: calls `uptime -p` via subprocess, `shutil.disk_usage("/")`, returns: system_uptime, disk_total_gb, disk_used_gb, disk_free_gb

Create `src/timelapse/web/blueprints/__init__.py` (empty file).

Create three stub blueprint files:
- `src/timelapse/web/blueprints/timeline.py`: Blueprint("timeline", __name__), single route "/" returning render_template("timeline.html")
- `src/timelapse/web/blueprints/latest.py`: Blueprint("latest", __name__), single route "/" returning render_template("latest.html")
- `src/timelapse/web/blueprints/control.py`: Blueprint("control", __name__), single route "/" returning render_template("control.html") -- NO auth yet (Plan 05 adds PAM auth)

Update `config/timelapse.yml` to add a commented-out `web:` section:
```yaml
# Web server settings
# web:
#   # Port to listen on (default: 8080)
#   port: 8080
#   # Host to bind to (default: 0.0.0.0 for all interfaces)
#   host: "0.0.0.0"
```

Also update `src/timelapse/config.py` DEFAULTS dict to add web defaults:
```python
"web": {
    "port": 8080,
    "host": "0.0.0.0",
},
```
  </action>
  <verify>
`python -c "from timelapse.web import create_app; print('OK')"` succeeds.
`python -c "from timelapse.web.health import get_health_summary, get_full_system_info; print('OK')"` succeeds.
  </verify>
  <done>Flask app factory creates a working app with three registered blueprints and a health context processor. Health module reads .status.json and aggregates system info. Web config defaults added.</done>
</task>

<task type="auto">
  <name>Task 2: Create base template, tab templates, and static assets</name>
  <files>src/timelapse/web/templates/base.html, src/timelapse/web/templates/timeline.html, src/timelapse/web/templates/latest.html, src/timelapse/web/templates/control.html, src/timelapse/web/static/css/pico.min.css, src/timelapse/web/static/css/app.css</files>
  <action>
Download Pico CSS v2.x and save as `src/timelapse/web/static/css/pico.min.css`. Use `curl -o` to fetch from https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css -- this vendors the file so the Pi works offline.

Create `src/timelapse/web/templates/base.html`:
- DOCTYPE html, lang="en", data-theme="light"
- Meta viewport for responsive
- Title block: `{% block title %}Timelapse{% endblock %} - RPi Timelapse`
- Link to vendored pico.min.css via url_for('static', filename='css/pico.min.css')
- Link to app.css via url_for('static', filename='css/app.css')
- Header with `<nav>` containing:
  - Left side: `<strong>RPi Timelapse</strong>` logo text
  - Right side: Three tab links using `<a>` elements:
    - "Timeline" linking to url_for('timeline.index'), with `aria-current="page"` when request.blueprint == 'timeline'
    - "Latest Image" linking to url_for('latest.index'), with aria-current when active
    - "Control" linking to url_for('control.index'), with aria-current when active
- Below the nav, a health indicator bar `<div class="health-bar">`:
  - Disk usage indicator: shows percentage, CSS class "warning" when `health.disk_warning` is True
  - Daemon status indicator: shows state (Running/Stopped/Error), CSS class matches state
  - Each indicator has a `data-tooltip` attribute with the full info (Pico CSS supports data-tooltip natively for simple tooltips)
  - Per user decision: hover state popup on any health indicator reveals full system info. Use Pico's native tooltip or a custom CSS hover popup with more detail: disk percentage + free GB, daemon state + last capture time, capture interval
- Main container with `{% block content %}{% endblock %}`
- Scripts block: `{% block scripts %}{% endblock %}`

Create `src/timelapse/web/templates/timeline.html`:
- Extends base.html
- Title block: "Timeline"
- Content block: placeholder `<p>Timeline view coming soon...</p>` (Plan 03 replaces this)

Create `src/timelapse/web/templates/latest.html`:
- Extends base.html
- Title block: "Latest Image"
- Content block: placeholder `<p>Latest Image view coming soon...</p>` (Plan 04 replaces this)

Create `src/timelapse/web/templates/control.html`:
- Extends base.html
- Title block: "Control"
- Content block: placeholder `<p>Control panel coming soon...</p>` (Plan 05 replaces this)

Create `src/timelapse/web/static/css/app.css` with custom styles:
- `.health-bar`: flex layout, small font, muted color, gap between items, positioned in header below nav
- `.health-item`: inline, small text (~0.75rem), light gray by default
- `.health-item.warning`: orange/red text + subtle background for disk warnings (noticeable but not alarming)
- `.health-item.running`: green indicator dot or text
- `.health-item.stopped`, `.health-item.error`: red/orange indicator
- `.health-item .health-popup`: hidden by default, shown on hover, positioned absolutely, contains full system info with multiple lines
- Desktop-first layout per user decision: container max-width comfortable for desktop
- Tab active state: Pico CSS handles aria-current styling, but add a subtle underline or bolder weight if needed
- Filmstrip container styles (placeholder for Plan 03): `.filmstrip` with `display: flex; overflow-x: auto; gap: 4px;`
- Thumbnail styles: `.thumb` at 120px height, cursor pointer, border for selected state
- `.thumb.selected`: visible border/outline to show selection
- Main image container: centered, max-width responsive
- Visual style per user decision: polished but not overdone -- clean borders, subtle shadows where appropriate, consistent spacing
  </action>
  <verify>
Start the Flask dev server and verify the page loads:
`cd /Users/jacobroufa/Code/rpi-timelapse-cam && python -c "
from timelapse.web import create_app
app = create_app()
with app.test_client() as client:
    resp = client.get('/')
    assert resp.status_code == 200
    assert b'Timeline' in resp.data
    assert b'Latest Image' in resp.data
    assert b'Control' in resp.data
    assert b'health-bar' in resp.data
    print('All assertions passed')
"`
  </verify>
  <done>Base template renders with three tab links, health indicator bar, and Pico CSS styling. Each tab has a placeholder template. The app responds to HTTP requests at /, /latest/, and /control/.</done>
</task>

</tasks>

<verification>
- Flask app starts without errors
- GET / returns 200 with "Timeline" tab content
- GET /latest/ returns 200 with "Latest Image" tab content
- GET /control/ returns 200 with "Control" tab content
- All three pages include the health indicator bar
- Pico CSS is served from static/css/pico.min.css
- Custom app.css is served from static/css/app.css
- Health data is injected into templates (even if .status.json is missing -- returns defaults)
</verification>

<success_criteria>
- Three-tab Flask app running with Pico CSS styling
- Health indicators visible on all tabs with disk usage and daemon status
- Warning state triggers visual change on disk indicator
- Tooltip/hover popup shows expanded health details
- Web config section added to config defaults and example YAML
</success_criteria>

<output>
After completion, create `.planning/phases/02-web-ui-timeline-browser/02-02-SUMMARY.md`
</output>
