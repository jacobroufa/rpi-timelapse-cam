---
phase: 02-web-ui-timeline-browser
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - src/timelapse/web/blueprints/timeline.py
  - src/timelapse/web/templates/timeline.html
  - src/timelapse/web/static/js/timeline.js
autonomous: true
requirements: [WEB-03, WEB-05]

must_haves:
  truths:
    - "User sees a horizontal filmstrip of 120px thumbnails at the top of the Timeline tab"
    - "Clicking a thumbnail shows the full-size image below the filmstrip"
    - "Left/Right arrow keys navigate between thumbnails within the current day"
    - "Up/Down arrow keys step to the previous/next day"
    - "Pressing 'd' opens the native date picker to jump to a specific day"
    - "Images from only the selected day are loaded at a time"
    - "Thumbnails use loading='lazy' for performance with large day directories"
  artifacts:
    - path: "src/timelapse/web/blueprints/timeline.py"
      provides: "Timeline routes: index, image serving, thumbnail serving, JSON API for dates and images"
      exports: ["timeline_bp"]
      contains: "send_from_directory"
    - path: "src/timelapse/web/templates/timeline.html"
      provides: "Timeline tab layout with filmstrip container and main image display"
      contains: "filmstrip"
    - path: "src/timelapse/web/static/js/timeline.js"
      provides: "Keyboard navigation, filmstrip scrolling, date picker interaction"
      contains: "ArrowLeft"
  key_links:
    - from: "src/timelapse/web/static/js/timeline.js"
      to: "src/timelapse/web/blueprints/timeline.py"
      via: "fetch /api/dates and /api/images/<date> for dynamic content"
      pattern: "fetch.*api"
    - from: "src/timelapse/web/templates/timeline.html"
      to: "src/timelapse/web/templates/base.html"
      via: "Jinja2 extends base.html"
      pattern: "extends"
    - from: "src/timelapse/web/blueprints/timeline.py"
      to: "filesystem"
      via: "pathlib.iterdir() to scan YYYY/MM/DD directories and serve images"
      pattern: "iterdir"
---

<objective>
Build the Timeline tab with a horizontal filmstrip of thumbnails, full-size image display, keyboard-driven navigation (arrow keys + "d" for date picker), and JSON API endpoints for date/image listing. This is the primary browsing interface for captured images.

Purpose: The Timeline tab is the core feature of the web UI -- it lets users browse through all captured images efficiently using keyboard navigation, similar to classic photo management tools like Lightroom's library view. The filmstrip pattern keeps the user oriented while viewing full-size images.

Output: Fully functional Timeline tab with filmstrip navigation, keyboard controls, and date picker.
</objective>

<execution_context>
@/Users/jacobroufa/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacobroufa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-web-ui-timeline-browser/02-RESEARCH.md
@.planning/phases/02-web-ui-timeline-browser/02-01-SUMMARY.md
@.planning/phases/02-web-ui-timeline-browser/02-02-SUMMARY.md
@src/timelapse/web/__init__.py
@src/timelapse/web/blueprints/timeline.py
@src/timelapse/web/templates/base.html
@src/timelapse/web/static/css/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build timeline blueprint with image/thumbnail serving and JSON API</name>
  <files>src/timelapse/web/blueprints/timeline.py</files>
  <action>
Replace the stub timeline blueprint with the full implementation.

Routes to create:

1. `GET /` (timeline.index): Renders timeline.html. Passes the list of available dates (from filesystem scan) and the currently selected date (from query param `?date=YYYY-MM-DD`, defaulting to the most recent date with images). Also passes the images for the selected date.

2. `GET /api/dates`: Returns JSON array of available date strings (YYYY-MM-DD format). Scans the output directory for YYYY/MM/DD directories containing at least one .jpg file. Results sorted ascending. This is used by the date picker to know which dates have images and by JS for Up/Down day navigation.

3. `GET /api/images/<date>`: Returns JSON array of image objects for a given date (format YYYY-MM-DD). Each object: `{"filename": "HHMMSS.jpg", "thumb_url": "/thumb/YYYY/MM/DD/HHMMSS.jpg", "full_url": "/image/YYYY/MM/DD/HHMMSS.jpg", "time": "HH:MM:SS"}`. Sorted ascending by filename. Date components are zero-padded as stored on disk.

4. `GET /image/<year>/<month>/<day>/<filename>`: Serves a full-size image from the output directory using `send_from_directory`. Returns 404 if directory or file does not exist.

5. `GET /thumb/<year>/<month>/<day>/<filename>`: Serves a thumbnail from the thumbs/ subdirectory within the day folder. Uses `send_from_directory` with `max_age=86400` (thumbnails are immutable). Returns 404 if not found. Falls back: if the thumbnail does not exist but the full image does, generate the thumbnail on-demand (for images captured before the backfill ran), save it, and serve it.

Helper functions (private):
- `_list_available_dates(output_dir: Path) -> list[str]`: Walk YYYY/MM/DD structure, return sorted date strings
- `_list_images_for_date(output_dir: Path, date_str: str) -> list[dict]`: Parse date string, list .jpg files in that day directory, return list of dicts with filename, thumb_url, full_url, time
- Filter out non-JPEG files and the `thumbs/` subdirectory when listing images

Validation: date parameters should be validated as digits and reasonable ranges. Use `abort(404)` for invalid paths. Never construct paths from user input without validation -- use send_from_directory which is safe against path traversal.
  </action>
  <verify>
`python -c "
from timelapse.web import create_app
app = create_app()
with app.test_client() as client:
    # API endpoints should return JSON
    resp = client.get('/api/dates')
    assert resp.status_code == 200
    assert resp.content_type.startswith('application/json')
    print('Timeline blueprint routes OK')
"`
  </verify>
  <done>Timeline blueprint serves full-size images, thumbnails (with on-demand fallback), and JSON API for dates and images. All paths validated, no path traversal possible.</done>
</task>

<task type="auto">
  <name>Task 2: Create timeline template and keyboard navigation JavaScript</name>
  <files>src/timelapse/web/templates/timeline.html, src/timelapse/web/static/js/timeline.js</files>
  <action>
Replace the stub `timeline.html` with the full implementation:

Template structure (extends base.html):
- Title block: "Timeline"
- Content block:
  - A small, unobtrusive `<input type="date" id="date-picker">` element. Style it to be visible but compact (maybe in the top-right corner of the timeline area). Set `min` and `max` attributes from the earliest and latest available dates. Set `value` to the currently selected date.
  - A `<div id="filmstrip" class="filmstrip" tabindex="0">` container. This is the horizontal scrollable strip.
    - For each image in the selected day: `<img class="thumb" src="{{ img.thumb_url }}" data-full-url="{{ img.full_url }}" data-index="{{ loop.index0 }}" loading="lazy" alt="Capture at {{ img.time }}">`
    - The first thumbnail has class "selected" by default
  - A `<div id="main-image-container" class="main-image-container">`:
    - `<img id="main-image" src="{{ images[0].full_url if images else '' }}" alt="Selected capture">`
    - A small timestamp overlay: `<span id="image-timestamp" class="image-timestamp">{{ images[0].time if images else '' }}</span>`
  - A `<div id="day-nav" class="day-nav">` showing the current date and navigation hints:
    - Current date display (e.g., "2026-02-16")
    - Keyboard hints text: "Arrow keys: navigate | Up/Down: change day | D: date picker"
  - If no images exist for the selected date (or no dates at all), show a message: "No images captured yet."
- Scripts block: include timeline.js

Create `src/timelapse/web/static/js/timeline.js`:

State variables:
- `currentIndex` (int): currently selected thumbnail index
- `currentDate` (string): currently displayed date (YYYY-MM-DD)
- `availableDates` (array): list of date strings from /api/dates
- `images` (array): image objects for the current day

On page load:
1. Fetch `/api/dates` to populate `availableDates` array
2. Set `currentDate` from the server-rendered date (data attribute on a hidden element or inline script)
3. The initial images are already rendered server-side in the template. Parse them from the DOM or store as a JSON script block.
4. Focus the filmstrip container so keyboard events work immediately

Keyboard event listener on the filmstrip container (keydown):
- **ArrowLeft**: Navigate to previous thumbnail (currentIndex - 1). If at index 0, do nothing.
- **ArrowRight**: Navigate to next thumbnail (currentIndex + 1). If at last index, do nothing.
- **ArrowUp**: Load the previous day. Find currentDate in availableDates, go to index - 1. If at first date, do nothing.
- **ArrowDown**: Load the next day. Find currentDate in availableDates, go to index + 1. If at last date, do nothing.
- **"d" or "D"**: Try `document.getElementById("date-picker").showPicker()` in a try/catch. On failure, focus the date input instead.
- Call `e.preventDefault()` on all handled keys to prevent page scrolling.

`navigateTo(index)` function:
- Remove "selected" class from current thumbnail
- Set currentIndex = index
- Add "selected" class to new thumbnail
- Scroll the new thumbnail into view: `thumbnails[index].scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" })`
- Update main-image src to the new thumbnail's data-full-url
- Update the timestamp overlay text

`loadDay(dateStr)` function:
- Fetch `/api/images/${dateStr}` to get the image list
- Update `currentDate`, `images` array
- Rebuild the filmstrip DOM: clear existing thumbnails, create new img elements for each image in the response
- Set currentIndex = 0, select first thumbnail
- Update the main image to the first image of the new day
- Update the date display and date picker value
- Re-focus the filmstrip container

Date picker change event listener:
- On change, call `loadDay(datePicker.value)`
- Only if the selected date exists in availableDates (validate before loading)

Per user decisions:
- All navigation fully keyboard-usable
- No modals, no inline expansion, no separate full-image page
- Filmstrip is always visible above the selected image
- Mouse click on thumbnail also selects it (add click handler on thumbnails)
  </action>
  <verify>
`python -c "
from timelapse.web import create_app
app = create_app()
with app.test_client() as client:
    resp = client.get('/')
    assert resp.status_code == 200
    assert b'filmstrip' in resp.data
    assert b'date-picker' in resp.data
    assert b'timeline.js' in resp.data
    print('Timeline template OK')
"`
  </verify>
  <done>Timeline tab displays a horizontal filmstrip of thumbnails with a large image below. Arrow keys navigate thumbnails (Left/Right) and days (Up/Down). "D" opens the date picker. Mouse click selects thumbnails. Day changes fetch new images via JSON API.</done>
</task>

</tasks>

<verification>
- GET / renders timeline with filmstrip container and main image area
- GET /api/dates returns JSON array of date strings
- GET /api/images/YYYY-MM-DD returns JSON array of image objects with thumb_url and full_url
- GET /image/YYYY/MM/DD/HHMMSS.jpg serves the full image
- GET /thumb/YYYY/MM/DD/HHMMSS.jpg serves the thumbnail (or generates on-demand)
- timeline.js is loaded and handles keyboard events
- Date picker input is present and functional
</verification>

<success_criteria>
- Filmstrip shows 120px thumbnails for the selected day
- Clicking a thumbnail shows the full-size image below
- Left/Right arrow keys navigate between thumbnails with smooth scrolling
- Up/Down arrow keys switch between days
- "D" key opens the native date picker
- Date picker jumps to the selected day
- loading="lazy" is on thumbnails for performance
- No modals or separate pages -- filmstrip always visible above the main image
</success_criteria>

<output>
After completion, create `.planning/phases/02-web-ui-timeline-browser/02-03-SUMMARY.md`
</output>
