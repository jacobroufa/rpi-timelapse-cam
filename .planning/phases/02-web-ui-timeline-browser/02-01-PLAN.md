---
phase: 02-web-ui-timeline-browser
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/timelapse/web/thumbnails.py
  - src/timelapse/daemon.py
  - src/timelapse/__main__.py
  - pyproject.toml
autonomous: true
requirements: [WEB-04]

must_haves:
  truths:
    - "Thumbnails are generated alongside full-size images at capture time"
    - "Existing images without thumbnails can be backfilled via CLI command"
    - "Thumbnails are 120px JPEG files in a thumbs/ subdirectory within each day folder"
  artifacts:
    - path: "src/timelapse/web/thumbnails.py"
      provides: "Thumbnail generation function"
      exports: ["generate_thumbnail"]
      contains: "Image.thumbnail"
    - path: "src/timelapse/daemon.py"
      provides: "Thumbnail call after successful capture"
      contains: "generate_thumbnail"
    - path: "pyproject.toml"
      provides: "Pillow and Flask dependencies"
      contains: "pillow"
  key_links:
    - from: "src/timelapse/daemon.py"
      to: "src/timelapse/web/thumbnails.py"
      via: "import and call after capture_with_timeout success"
      pattern: "generate_thumbnail"
    - from: "src/timelapse/__main__.py"
      to: "src/timelapse/web/thumbnails.py"
      via: "backfill subcommand walks dirs and calls generate_thumbnail"
      pattern: "generate_thumbnail"
---

<objective>
Create the thumbnail generation module and integrate it into the Phase 1 capture daemon so that thumbnails are pre-generated at capture time. Also add a backfill CLI command for existing images and update pyproject.toml with new dependencies.

Purpose: Pre-generated thumbnails are critical for fast timeline browsing on the Pi. On-the-fly generation would take 200-500ms per image and make the timeline unusable. This plan modifies the existing daemon to generate thumbnails as a side-effect of each capture, and provides a one-time backfill command for images captured before this change.

Output: Thumbnail module, modified daemon, backfill CLI command, updated dependencies.
</objective>

<execution_context>
@/Users/jacobroufa/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacobroufa/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-web-ui-timeline-browser/02-RESEARCH.md
@src/timelapse/daemon.py
@src/timelapse/__main__.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create thumbnail module and update dependencies</name>
  <files>src/timelapse/web/__init__.py, src/timelapse/web/thumbnails.py, pyproject.toml</files>
  <action>
Create the `src/timelapse/web/` package directory with an empty `__init__.py`.

Create `src/timelapse/web/thumbnails.py` with a `generate_thumbnail(image_path: Path, thumb_dir: Path | None = None) -> Path` function:
- Default thumb_dir is `image_path.parent / "thumbs"`
- Creates thumb_dir if it does not exist (`mkdir(exist_ok=True)`)
- If the thumbnail already exists at the target path, return early (idempotent)
- Open the image with `PIL.Image.open()` (lazy -- uses JPEG draft mode internally)
- Call `im.thumbnail((120, 120))` to resize in-place, preserving aspect ratio
- Save as JPEG with quality=60 to `thumb_dir / image_path.name`
- Return the path to the generated thumbnail

Update `pyproject.toml` dependencies:
- Add `"pillow>=12.0"` to the main `dependencies` list (thumbnail generation is now core, not optional)
- Add `"flask>=3.1,<4"`, `"python-pam>=2.0"`, `"Flask-HTTPAuth>=4.8"` to main dependencies (needed for Phase 2 web server)
- Keep the existing `camera` optional dependency group unchanged
  </action>
  <verify>
`python -c "from timelapse.web.thumbnails import generate_thumbnail; print('OK')"` succeeds.
`grep -q "pillow" pyproject.toml && grep -q "flask" pyproject.toml && echo OK` prints OK.
  </verify>
  <done>Thumbnail module importable, generates 120px JPEG thumbnails in thumbs/ subdirectory. pyproject.toml includes Pillow, Flask, python-pam, Flask-HTTPAuth.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate thumbnail generation into daemon and add backfill CLI</name>
  <files>src/timelapse/daemon.py, src/timelapse/__main__.py</files>
  <action>
Modify `src/timelapse/daemon.py` `_capture_once()` method:
- After a successful capture (inside the `if success:` block, after setting `self._last_capture_success = True`), call `generate_thumbnail(output_path)`.
- Import at the top of the file: `from timelapse.web.thumbnails import generate_thumbnail`
- Wrap the thumbnail call in a try/except so thumbnail failure never breaks the capture loop. Log a warning on failure.
- The thumbnail call adds ~50ms per capture which is negligible vs the 30-60s interval.

Modify `src/timelapse/__main__.py` to support subcommands:
- Keep the existing behavior as the default (no subcommand = run the daemon)
- Add a `generate-thumbnails` subcommand that walks the output directory tree, finds all .jpg files that do NOT have a corresponding thumbnail in their `thumbs/` subdirectory, and generates thumbnails for them
- The subcommand should accept `--config PATH` (same fallback chain as the daemon) to determine the output directory
- Print progress: "Generated thumbnail for YYYY/MM/DD/HHMMSS.jpg" for each file
- Print a summary at the end: "Generated N thumbnails for M images (K already had thumbnails)"
- Use argparse subparsers: `timelapse` (default, daemon), `timelapse generate-thumbnails` (backfill)
  </action>
  <verify>
The daemon module imports cleanly: `python -c "from timelapse.daemon import CaptureDaemon; print('OK')"`.
The CLI shows help for generate-thumbnails: `python -m timelapse generate-thumbnails --help`.
  </verify>
  <done>Daemon generates thumbnails after each successful capture. `timelapse generate-thumbnails` backfills existing images. Thumbnail failures are logged but never crash the daemon.</done>
</task>

</tasks>

<verification>
- `python -c "from timelapse.web.thumbnails import generate_thumbnail"` succeeds
- `python -c "from timelapse.daemon import CaptureDaemon"` succeeds (thumbnail import does not break daemon)
- `python -m timelapse --help` shows usage (daemon mode still works)
- `python -m timelapse generate-thumbnails --help` shows backfill usage
- pyproject.toml contains pillow, flask, python-pam, Flask-HTTPAuth in dependencies
</verification>

<success_criteria>
- Thumbnail module exists at src/timelapse/web/thumbnails.py with generate_thumbnail()
- Daemon calls generate_thumbnail() after each successful capture
- Backfill CLI command can process an output directory of existing images
- All new dependencies declared in pyproject.toml
</success_criteria>

<output>
After completion, create `.planning/phases/02-web-ui-timeline-browser/02-01-SUMMARY.md`
</output>
